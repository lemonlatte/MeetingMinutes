{% load raw_input %}

<!DOCTYPE html>
<html ng-app="basic">
<head>
    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <link href="/static/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="/static/css/site.less">
    <script type="text/javascript" src="/static/js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/angular-1.0.1.min.js"></script>
    <script type="text/javascript" src="/static/js/less-1.3.0.min.js"></script>
    <script type="text/javascript" src="/static/js/site.js"></script>
</head>

<script type="text/javascript">

    angular.module('basic', []).config(function($httpProvider) {
        $httpProvider.defaults.headers.common['X-CSRFToken'] = $.getCookie("csrftoken");
        $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
    });

    function MeetingMinuteCtrl($scope, $http){

        $http.get("/list").success(function(data){
            $scope.meetings = data;
        });

        $scope.addMeeting = function(){
            var data = $(addMeetingForm).serialize();
            $http.post("/add", data).success(function(data){
                $scope.meetings.push(data);
                $("#minute-detail").modal("hide");
            });
        };

        $scope.delMeeting = function(index){
            $http.post("/delete", $.param({"_id": $scope.meetings[index]._id}))
            .success(function(data){
                    $scope.meetings.splice(index, 1);
            });
        };

        $scope.addMeetingPopup = function(){
            $(addMeetingForm).each(function(){this.reset();});
            $("#minute-detail").modal("show");
        };

        $scope.addMinute = function(meeting_index){
            $scope.target = $scope.meetings[meeting_index];
            data = $scope.target.newMinute
            $http.post("/"+ $scope.target._id +"/add", $.param(data))
            .success(function(data){
                $scope.target.minutes.push(data);
                $scope.target.insertMinute = false;
            });
        };

        $scope.delMinute = function(meeting_index, index){
            $scope.target = $scope.meetings[meeting_index];
            $http.post("/"+ $scope.target._id +"/delete",
                       $.param({"index": index}))
            .success(function(index){
                $scope.target.minutes.splice(index, 1);
            });
        };

    }

</script>

<body ng-controller="MeetingMinuteCtrl">
<div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="#">Meeting Minutes</a>
        <div class="nav-collapse">
          <ul class="nav">
            <li><a href="#" ng-click="addMeetingPopup()">Add</a></li>
          </ul>
        </div><!-- /.nav-collapse -->
      </div><!-- /.container -->
    </div><!-- /navbar-inner -->
</div>

<div class="container">

<div class="meeting-block" ng-repeat="meeting in meetings">
    {% raw %}
    <div class="header">
        <h3>{{meeting.meeting_name}}</h3>
        <button type="button" class="close" ng-click="delMeeting($index)">×</button>
    </div>
    <div class="body">
        <p>Date/Time: {{meeting.create_time}}</p>
        <p>Attendees: {{meeting.attendees}}</p>
        <p>Purpose: {{meeting.purpose}}</p>
        <p>Minutes: </p>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th><a class="icon-plus-sign" ng-click="meeting.newMinute={};meeting.insertMinute=true"></a></th>
                    <th>#</th>
                    <th class="span4">Topic</th>
                    <th class="span4">Discussion</th>
                    <th class="span4">Consensus</th>
                </tr>
            </thead>
             <tbody ng-init="meeting_index=$index">
                <tr ng-repeat="minute in meeting.minutes">
                    <td><a class="icon-minus-sign" ng-click="delMinute(meeting_index, $index)"></a></td>
                    <td>{{ $index + 1 }}</td>
                    <td>{{minute.topic}}</td>
                    <td>{{minute.discussion}}</td>
                    <td>{{minute.consensus}}</td>
                </tr>
                <tr ng-Show="meeting.insertMinute">
                    <td><a class="icon-ok" ng-click="addMinute($index)"></a></td>
                    <td><a class="icon-remove" ng-click="meeting.insertMinute=false"></a></td>
                    <td><input ng-model="meeting.newMinute.topic" type="text"></td>
                    <td><textarea ng-model="meeting.newMinute.discussion"></textarea></td>
                    <td><textarea ng-model="meeting.newMinute.consensus"></textarea></td>
                </tr>
                <tr ng-Show="meeting.minutes.length==0">
                    <td colspan="5">You don't have any minutes.</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endraw %}
</div>
</div>

<div id="minute-detail" class="modal hide fade">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal">×</button>
      <h3>Add a new Meeting</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal" name="addMeetingForm">
            <div class="control-group">
              <label class="control-label" for="meeting_name">Meeting Name</label>
              <div class="controls">
                <input type="text" id="meeting_name" name="meeting_name">
              </div>
            </div>

            <div class="control-group">
              <label class="control-label" for="attendees">Attendees</label>
              <div class="controls">
                <input type="text" id="attendees" name="attendees">
              </div>
            </div>

            <div class="control-group">
              <label class="control-label" for="purpose">Purpose</label>
              <div class="controls">
                <textarea id="purpose" name="purpose"></textarea>
              </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
      <a href="#" class="btn" data-dismiss="modal">Close</a>
      <a href="#" class="btn btn-primary" ng-click="addMeeting()">Save changes</a>
    </div>
</div>
</body>
</html>
